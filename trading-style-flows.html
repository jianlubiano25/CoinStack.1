<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trading Style Flows</title>
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/trading.css">
  <style>
    body {
      background: linear-gradient(120deg, #181926 60%, #23243a 100%);
      color: #fff;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1300px;
      margin: 48px auto 0 auto;
      padding: 40px 40px 32px 40px;
      background: rgba(36, 37, 54, 0.82);
      border-radius: 28px;
      box-shadow: 0 8px 48px 0 rgba(139, 92, 246, 0.13);
      backdrop-filter: blur(8px) saturate(1.2);
      border: 1.5px solid rgba(139,92,246,0.18);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
    }
    .header-title {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -1.5px;
      color: #a78bfa;
      text-shadow: 0 2px 12px #23243a44;
    }
    .back-link {
      color: #10b981;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      transition: color 0.2s;
    }
    .back-link:hover {
      color: #8b5cf6;
    }
    .search-add-bar {
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: stretch;
      margin-bottom: 38px;
      background: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
    }
    .search-bar {
      width: 100%;
      position: relative;
      margin-bottom: 8px;
    }
    .search-input {
      width: 100%;
      padding: 14px 44px 14px 44px;
      border-radius: 10px;
      border: none;
      background: #181926;
      color: #fff;
      font-size: 1.1rem;
      outline: none;
      box-shadow: 0 1px 4px 0 rgba(139,92,246,0.07);
      transition: box-shadow 0.2s;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .search-input:focus {
      box-shadow: 0 2px 12px 0 #8b5cf6aa;
    }
    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      color: #8b5cf6;
      pointer-events: none;
    }
    .add-btn {
      background: linear-gradient(90deg, #10b981 60%, #8b5cf6 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0 28px;
      font-weight: 700;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px 0 #10b98133;
    }
    .add-btn:hover {
      background: linear-gradient(90deg, #8b5cf6 0%, #10b981 100%);
      box-shadow: 0 4px 16px 0 #8b5cf633;
    }
    .card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 36px;
      margin-top: 32px;
      justify-content: flex-start;
    }
    .flow-card {
      background: rgba(36, 37, 54, 0.98);
      border: 2.5px solid #8b5cf6;
      border-radius: 20px;
      box-shadow: 0 4px 32px 0 rgba(139, 92, 246, 0.10);
      color: #fff;
      width: 100%;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 100%;
      padding: 22px 18px 18px 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .flow-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.05rem;
      font-weight: 700;
      color: #a78bfa;
      margin-bottom: 10px;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .flow-stepper {
      display: flex;
      align-items: center;
      gap: 0px;
      width: 100%;
      flex-wrap: wrap;
      padding-bottom: 2px;
      justify-content: flex-start;
    }
    .flow-step {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(139,92,246,0.10);
      border-radius: 999px;
      padding: 6px 12px;
      margin: 4px 4px 0 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      box-shadow: 0 2px 8px 0 rgba(139,92,246,0.04);
      font-size: 0.98rem;
      font-weight: 500;
      transition: background 0.2s;
    }
    .flow-step-icon {
      font-size: 1.15rem;
      margin-bottom: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .flow-step-label {
      font-size: 0.97rem;
      color: #a5b4fc;
      font-weight: 600;
      text-align: center;
      margin-bottom: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .flow-step-desc {
      font-size: 0.89rem;
      color: #cbd5e1;
      text-align: center;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    .flow-arrow {
      font-size: 1.3rem;
      color: #8b5cf6;
      margin: 0 3px 0 0;
      flex-shrink: 0;
    }
    textarea.add-input, textarea.edit-flow-input {
      width: 100%;
      min-height: 38px;
      max-height: 120px;
      resize: vertical;
      font-size: 1rem;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      border-radius: 8px;
      border: none;
      background: #181926;
      color: #fff;
      padding: 10px 14px;
      outline: none;
      box-shadow: 0 1px 4px 0 rgba(139,92,246,0.07);
      margin-bottom: 0;
      transition: box-shadow 0.2s;
    }
    textarea.add-input:focus, textarea.edit-flow-input:focus {
      box-shadow: 0 2px 12px 0 #8b5cf6aa;
    }
    .dark-paragraph, p.dark-paragraph {
      background: #181926;
      color: #e0e7ef;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 18px;
      font-size: 1.08rem;
      line-height: 1.7;
      box-shadow: 0 1px 4px 0 rgba(139,92,246,0.07);
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    
    /* Enhanced Responsive Design */
    @media (max-width: 1200px) {
      .container {
        max-width: 95vw;
        padding: 30px 25px 25px 25px;
        margin: 30px auto 0 auto;
      }
      .header-title {
        font-size: 2.2rem;
      }
      .card-grid {
        gap: 24px;
      }
    }
    
    @media (max-width: 900px) {
      .container {
        max-width: 98vw;
        padding: 20px 15px 20px 15px;
        margin: 20px auto 0 auto;
        border-radius: 20px;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
      }
      .header-title {
        font-size: 1.8rem;
        letter-spacing: -1px;
      }
      .flow-card {
        min-width: 0;
        max-width: 100%;
        width: 100%;
        padding: 16px 12px 12px 12px;
        border-radius: 16px;
      }
      .flow-title {
        font-size: 0.95rem;
        flex-wrap: wrap;
        gap: 8px;
      }
      .flow-stepper {
        gap: 2px;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
      .flow-step {
        min-width: 0;
        max-width: calc(100% - 8px);
        padding: 4px 8px;
        font-size: 0.85rem;
        margin: 2px 2px 0 0;
        flex-shrink: 1;
      }
      .flow-step-icon {
        font-size: 1rem;
      }
      .flow-step-label {
        font-size: 0.85rem;
      }
      .flow-step-desc {
        font-size: 0.8rem;
      }
      .flow-arrow {
        font-size: 1.1rem;
        margin: 0 2px 0 0;
      }
      .search-bar {
        margin-bottom: 12px;
      }
      .search-input {
        padding: 12px 40px 12px 40px;
        font-size: 1rem;
      }
      .search-icon {
        left: 14px;
        font-size: 1.3rem;
      }
      .dark-paragraph {
        font-size: 1rem;
        padding: 12px 14px;
        margin-bottom: 16px;
      }
    }
    
    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        padding: 15px 10px 15px 10px;
        margin: 10px auto 0 auto;
        border-radius: 16px;
      }
      .header-title {
        font-size: 1.6rem;
        letter-spacing: -0.5px;
      }
      .back-link {
        font-size: 1rem;
        margin-bottom: 16px;
      }
      .flow-card {
        padding: 14px 10px 10px 10px;
        border-radius: 12px;
        border-width: 2px;
      }
      .flow-title {
        font-size: 0.9rem;
        margin-bottom: 8px;
      }
      .flow-stepper {
        gap: 1px;
        padding-bottom: 0;
      }
      .flow-step {
        padding: 3px 6px;
        font-size: 0.8rem;
        margin: 1px 1px 0 0;
        border-radius: 6px;
      }
      .flow-step-icon {
        font-size: 0.9rem;
      }
      .flow-step-label {
        font-size: 0.8rem;
      }
      .flow-step-desc {
        font-size: 0.75rem;
      }
      .flow-arrow {
        font-size: 1rem;
        margin: 0 1px 0 0;
      }
      .search-input {
        padding: 10px 36px 10px 36px;
        font-size: 0.95rem;
        border-radius: 8px;
      }
      .search-icon {
        left: 12px;
        font-size: 1.2rem;
      }
      .add-btn {
        padding: 0 20px;
        font-size: 1.1rem;
        border-radius: 8px;
      }
      .dark-paragraph {
        font-size: 0.95rem;
        padding: 10px 12px;
        margin-bottom: 12px;
        border-radius: 8px;
      }
      textarea.add-input, textarea.edit-flow-input {
        font-size: 0.95rem;
        padding: 8px 12px;
        border-radius: 6px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 12px 8px 12px 8px;
        margin: 5px auto 0 auto;
      }
      .header-title {
        font-size: 1.4rem;
      }
      .flow-card {
        padding: 12px 8px 8px 8px;
      }
      .flow-title {
        font-size: 0.85rem;
      }
      .flow-step {
        padding: 2px 5px;
        font-size: 0.75rem;
        margin: 1px 1px 0 0;
      }
      .flow-step-icon {
        font-size: 0.85rem;
      }
      .flow-step-label {
        font-size: 0.75rem;
      }
      .flow-step-desc {
        font-size: 0.7rem;
      }
      .flow-arrow {
        font-size: 0.9rem;
      }
      .search-input {
        padding: 8px 32px 8px 32px;
        font-size: 0.9rem;
      }
      .search-icon {
        left: 10px;
        font-size: 1.1rem;
      }
      .add-btn {
        padding: 0 16px;
        font-size: 1rem;
      }
      .dark-paragraph {
        font-size: 0.9rem;
        padding: 8px 10px;
      }
    }
    
         /* Mobile-specific improvements */
     @media (max-width: 600px) {
       .search-add-bar {
         gap: 12px;
         margin-bottom: 24px;
       }
       
       /* Improve form layout on mobile */
       .add-form-container {
         flex-direction: column;
         gap: 8px;
       }
       
       .add-form-container > * {
         width: 100%;
         min-width: auto;
       }
      
      /* Better button sizing on mobile */
      .add-btn {
        align-self: stretch;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Improve import/export buttons */
      .import-export-bar {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }
      
      .import-export-bar > * {
        width: 100%;
        text-align: center;
      }
      
      /* Better card actions on mobile */
      .flow-card .flow-title > div:last-child {
        gap: 6px;
      }
      
      .flow-card .flow-title button {
        font-size: 1rem;
        padding: 4px;
      }
    }
    
         /* Touch-friendly improvements */
     @media (hover: none) and (pointer: coarse) {
       .flow-step {
         min-height: 32px;
       }
       
       .add-btn, .export-btn, .import-btn {
         min-height: 44px;
       }
       
       .flow-card .flow-title button {
         min-width: 32px;
         min-height: 32px;
         display: flex;
         align-items: center;
         justify-content: center;
       }
       
       /* Better touch targets */
       .search-input, .add-title-input, textarea.add-input {
         min-height: 44px;
       }
       
       .flow-card {
         margin-bottom: 12px;
       }
       
       /* Mobile step improvements */
       .mobile-step {
         flex-direction: column;
         align-items: center;
         text-align: center;
         padding: 6px 8px;
         min-width: 80px;
       }
       
       .mobile-step .flow-step-icon {
         margin-bottom: 2px;
       }
       
       .mobile-step .flow-step-label {
         font-size: 0.75rem;
         margin-bottom: 1px;
       }
       
       .mobile-step .flow-step-desc {
         font-size: 0.65rem;
         line-height: 1.2;
       }
     }
     
     /* Landscape mobile improvements */
     @media (max-width: 900px) and (orientation: landscape) {
       .container {
         padding: 15px 20px 15px 20px;
         margin: 10px auto 0 auto;
       }
       
       .header {
         flex-direction: row;
         align-items: center;
         gap: 15px;
         margin-bottom: 15px;
       }
       
       .header-title {
         font-size: 1.6rem;
       }
       
       .search-add-bar {
         margin-bottom: 20px;
       }
     }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html#trading-tools" class="back-link">← Back to Trading Tools</a>
    <div class="header">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
        <rect x="6" y="12" width="28" height="16" rx="6" fill="#8b5cf6" opacity="0.18"/>
        <rect x="10" y="16" width="20" height="8" rx="4" fill="#a78bfa"/>
        <rect x="16" y="20" width="8" height="4" rx="2" fill="#10b981"/>
      </svg>
      <span class="header-title">Trading Style Flows</span>
    </div>
    <div class="dark-paragraph">Explore and document your favorite style flow setups here.</div>

    <!-- Search and Add Section -->
    <div class="search-add-bar">
      <div class="search-bar">
        <input class="search-input" type="text" placeholder="Search style flows...">
        <span class="search-icon">🔍</span>
      </div>
      <div class="add-form-container" style="display:flex; gap:8px; align-items:flex-start; width:100%; flex-wrap:wrap;">
        <input class="add-title-input" type="text" placeholder="Title (e.g. My Flow Name)" style="flex:1; min-width:120px; padding:10px 14px; border-radius:8px; border:none; background:#181926; color:#fff; font-size:1rem; outline:none; box-shadow:0 1px 4px 0 rgba(139,92,246,0.07); font-family:'Inter', 'Segoe UI', Arial, sans-serif;">
        <textarea class="add-input dark-paragraph" placeholder="Add new style flow (paste or type here)..." style="flex:2; min-width:160px; resize:vertical; min-height:38px; max-height:120px; border:none; color:#fff; font-size:1rem; outline:none; box-shadow:0 1px 4px 0 rgba(139,92,246,0.07); font-family:'Inter', 'Segoe UI', Arial, sans-serif; overflow:auto;"></textarea>
        <button class="add-btn" style="align-self:center;">＋</button>
      </div>
      <div class="import-export-bar" style="display:flex; gap:12px; margin-top:10px; align-items:center;">
        <button class="export-btn" style="background:linear-gradient(90deg,#8b5cf6 60%,#10b981 100%);color:#fff;border:none;border-radius:8px;padding:8px 22px;font-weight:600;font-size:1rem;cursor:pointer;box-shadow:0 2px 8px 0 #8b5cf633;transition:background 0.2s;">Export</button>
        <label for="importFlowsInput" class="import-btn" style="background:linear-gradient(90deg,#10b981 60%,#8b5cf6 100%);color:#fff;border:none;border-radius:8px;padding:8px 22px;font-weight:600;font-size:1rem;cursor:pointer;box-shadow:0 2px 8px 0 #10b98133;transition:background 0.2s;display:inline-block;">Import<input id="importFlowsInput" type="file" accept="application/json" style="display:none;"></label>
        <span class="import-export-msg" style="color:#a5b4fc;font-size:0.98rem;margin-left:8px;"></span>
      </div>
    </div>

    <div class="card-grid" id="flowCardsContainer">
      <!-- Cards will be rendered here by JS -->
    </div>

    <script>
    // --- ICON MAP ---
    const ICON_MAP = {
      'EQH': '🔺',
      'EQL': '🔻',
      'CHoCH': '🔄',
      'OB': '🟪',
      'FVG': '🟪',
      'BOS': '🏗️',
      'Entry': '✅',
      'Long': '🟢',
      'Short': '🔴',
      'Break': '⚡',
      'Retest': '🔁',
      'Reversal': '🔃',
      'Sweep': '💧',
      'Trend': '📈',
      'Support': '🟩',
      'Resistance': '🟥',
      'OB/FVG': '🟪',
      'OB/FVG retest': '🟪',
      'CHoCH appears': '🔄',
      'BOS confirms trend': '🏗️',
      'swept': '💧',
      'appears': '✨',
      'confirms trend': '📈',
      'retest': '🔁',
      '': ''
    };

    // --- LOCAL STORAGE ---
    const STORAGE_KEY = 'tradingStyleFlows';
    function getFlows() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch { return []; }
    }
    function saveFlows(flows) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(flows));
    }

    // --- RENDERING ---
    function renderFlows(editIndex = null) {
      const flows = getFlows();
      const container = document.getElementById('flowCardsContainer');
      container.innerHTML = '';
      if (!flows.length) {
        // Show sample if no entries
        container.innerHTML = `
        <div class="flow-card">
          <div class="flow-title"><span style="font-size:2.1rem;">🧭</span>Craig-Style Reversal Flow</div>
          <div class="flow-stepper">
            <div class="flow-step"><span class="flow-step-icon">🔺</span><span class="flow-step-label" style="color:#f87171;">EQH</span><span class="flow-step-desc">or</span><span class="flow-step-icon">🔻</span><span class="flow-step-label" style="color:#60a5fa;">EQL</span><span class="flow-step-desc">swept</span></div>
            <span class="flow-arrow">→</span>
            <div class="flow-step"><span class="flow-step-icon">🔄</span><span class="flow-step-label" style="color:#fbbf24;">CHoCH</span><span class="flow-step-desc">appears</span></div>
            <span class="flow-arrow">→</span>
            <div class="flow-step"><span class="flow-step-icon">🟪</span><span class="flow-step-label" style="color:#a78bfa;">OB/FVG</span><span class="flow-step-desc">retest</span></div>
            <span class="flow-arrow">→</span>
            <div class="flow-step"><span class="flow-step-icon">🏗️</span><span class="flow-step-label" style="color:#10b981;">BOS</span><span class="flow-step-desc">confirms trend</span></div>
            <span class="flow-arrow">→</span>
            <div class="flow-step"><span class="flow-step-icon">✅</span><span class="flow-step-label" style="color:#10b981;">Entry</span></div>
          </div>
        </div>`;
        return;
      }
      flows.forEach((flow, i) => {
        if (editIndex === i) {
          container.innerHTML += editFlowCardHTML(flow.title, flow.flow, i);
        } else {
          container.innerHTML += flowCardHTML(flow.title, flow.flow, i);
        }
      });
    }

    function flowCardHTML(title, flow, i, highlightQ = null) {
      const steps = flow.split(/\s*(?:→|->)\s*/g).map(s => s.trim()).filter(Boolean);
      let html = `<div class="flow-card" data-index="${i}">
        <div style="display:flex; align-items:center; justify-content:space-between; width:100%; margin-bottom:2px;">
          <div class="flow-title"><span style="font-size:1.5rem;">🧭</span>${highlightQ ? highlightMatch(title, highlightQ) : escapeHTML(title)}</div>
          <div style="display:flex; gap:8px;">
            <button class="edit-btn" title="Edit" style="background:none; border:none; color:#a78bfa; font-size:1.1rem; cursor:pointer; padding:4px; border-radius:4px; transition:background 0.2s;">✏️</button>
            <button class="delete-btn" title="Delete" style="background:none; border:none; color:#f87171; font-size:1.1rem; cursor:pointer; padding:4px; border-radius:4px; transition:background 0.2s;">🗑️</button>
          </div>
        </div>
        <div class="flow-stepper">`;
      steps.forEach((step, j) => {
        let icon = '';
        let label = step;
        let desc = '';
        for (const key in ICON_MAP) {
          if (step.toUpperCase().includes(key.toUpperCase())) {
            icon = ICON_MAP[key];
            break;
          }
        }
        if (step.match(/\b(or|and|then|after|before|appears|swept|retest|confirms|entry)\b/i)) {
          const parts = step.split(/\b(or|and|then|after|before|appears|swept|retest|confirms|entry)\b/i);
          label = parts[0].trim();
          desc = parts.slice(1).join('').trim();
        }
        // Remove brackets from label and desc for display
        label = label.replace(/[\[\]]/g, '');
        desc = desc.replace(/[\[\]]/g, '');
        
        // Mobile-friendly step display
        const isMobile = window.innerWidth <= 600;
        const stepClass = isMobile ? 'flow-step mobile-step' : 'flow-step';
        
        html += `<div class="${stepClass}">${icon ? `<span class='flow-step-icon'>${icon}</span>` : ''}<span class="flow-step-label">${highlightQ ? highlightMatch(label, highlightQ) : escapeHTML(label)}</span>${desc ? `<span class="flow-step-desc">${highlightQ ? highlightMatch(desc, highlightQ) : escapeHTML(desc)}</span>` : ''}</div>`;
        if (j < steps.length - 1) html += `<span class="flow-arrow">→</span>`;
      });
      html += '</div></div>';
      return html;
    }

    function editFlowCardHTML(title, flow, i) {
      return `<div class="flow-card" data-index="${i}">
        <div style="display:flex; align-items:center; justify-content:space-between; width:100%; margin-bottom:2px;">
          <div class="flow-title"><span style="font-size:1.5rem;">🧭</span><input class="edit-title-input" value="${escapeHTML(title)}" style="font-size:1.05rem; font-family:'Inter',sans-serif; border-radius:6px; border:none; padding:4px 8px; background:#181926; color:#fff; width:160px; margin-right:8px;" /></div>
          <div style="display:flex; gap:8px;">
            <button class="save-btn" title="Save" style="background:none; border:none; color:#10b981; font-size:1.1rem; cursor:pointer;">💾</button>
            <button class="cancel-btn" title="Cancel" style="background:none; border:none; color:#a5b4fc; font-size:1.1rem; cursor:pointer;">✖️</button>
          </div>
        </div>
        <textarea class="edit-flow-input dark-paragraph" style="width:100%; font-size:0.97rem; font-family:'Inter',sans-serif; border:none; color:#fff; margin-bottom:8px; resize:vertical; min-height:38px; max-height:240px; overflow:auto;">${escapeHTML(flow)}</textarea>
      </div>`;
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(tag) {
        const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return charsToReplace[tag] || tag;
      });
    }

    // --- ADD ENTRY ---
    document.querySelector('.add-btn').onclick = function() {
      const titleInput = document.querySelector('.add-title-input');
      const flowInput = document.querySelector('.add-input');
      const title = titleInput.value.trim();
      const flow = flowInput.value.trim();
      
      // Better validation with user feedback
      if (!title) {
        titleInput.style.borderColor = '#ef4444';
        titleInput.placeholder = 'Title is required!';
        setTimeout(() => {
          titleInput.style.borderColor = '';
          titleInput.placeholder = 'Title (e.g. My Flow Name)';
        }, 2000);
        return;
      }
      if (!flow) {
        flowInput.style.borderColor = '#ef4444';
        flowInput.placeholder = 'Flow content is required!';
        setTimeout(() => {
          flowInput.style.borderColor = '';
          flowInput.placeholder = 'Add new style flow (paste or type here)...';
        }, 2000);
        return;
      }
      
      const flows = getFlows();
      flows.unshift({ title, flow }); // Add to top
      saveFlows(flows);
      renderFlows();
      titleInput.value = '';
      flowInput.value = '';
      
      // Mobile-friendly feedback
      const addBtn = document.querySelector('.add-btn');
      const originalText = addBtn.textContent;
      addBtn.textContent = '✓ Added!';
      addBtn.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
      setTimeout(() => {
        addBtn.textContent = originalText;
        addBtn.style.background = '';
      }, 1500);
    };

    // --- EDIT/DELETE HANDLERS ---
    document.getElementById('flowCardsContainer').onclick = function(e) {
      const card = e.target.closest('.flow-card');
      if (!card) return;
      const idx = parseInt(card.getAttribute('data-index'));
      if (e.target.classList.contains('edit-btn')) {
        renderFlows(idx);
      } else if (e.target.classList.contains('delete-btn')) {
        if (confirm('Delete this flow?')) {
          const flows = getFlows();
          flows.splice(idx, 1);
          saveFlows(flows);
          renderFlows();
        }
      } else if (e.target.classList.contains('save-btn')) {
        const newTitle = card.querySelector('.edit-title-input').value.trim();
        const newFlow = card.querySelector('.edit-flow-input').value.trim();
        if (!newTitle || !newFlow) return;
        const flows = getFlows();
        flows[idx] = { title: newTitle, flow: newFlow };
        saveFlows(flows);
        renderFlows();
      } else if (e.target.classList.contains('cancel-btn')) {
        renderFlows();
      }
    };

    // --- RENDER ON LOAD ---
    renderFlows();
    
    // Handle window resize for responsive updates
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        // Re-render flows to update mobile step classes
        const currentSearchQuery = document.querySelector('.search-input').value.trim();
        if (currentSearchQuery) {
          // If there's an active search, re-apply it
          const flows = getFlows();
          const container = document.getElementById('flowCardsContainer');
          container.innerHTML = '';
          const filtered = searchFlows(flows, currentSearchQuery);
          if (filtered.length) {
            filtered.forEach((flow, i) => {
              container.innerHTML += flowCardHTML(flow.title, flow.flow, i, currentSearchQuery);
            });
          }
        } else {
          renderFlows();
        }
      }, 150);
    });

    // --- SEARCH (optimized multi-word, fuzzy, debounced) ---
    function fuzzyMatch(str, q) {
      if (!q) return true;
      str = str.toLowerCase();
      q = q.toLowerCase();
      if (str.includes(q)) return true;
      // Simple fuzzy: allow 1 char difference for short queries
      if (q.length <= 3) {
        for (let i = 0; i < str.length; i++) {
          let miss = str.slice(0, i) + str.slice(i + 1);
          if (miss.includes(q)) return true;
        }
      }
      return false;
    }
    function searchFlows(flows, query) {
      if (!query) return flows;
      const tokens = query.trim().toLowerCase().split(/\s+/).filter(Boolean);
      return flows.filter(f => {
        const title = f.title.toLowerCase();
        const steps = f.flow.split(/\s*(?:→|->)\s*/g).map(s => s.trim().toLowerCase());
        // All tokens must be present in title or any step
        return tokens.every(token =>
          fuzzyMatch(title, token) || steps.some(step => fuzzyMatch(step, token))
        );
      });
    }
    let searchTimeout = null;
    document.querySelector('.search-input').addEventListener('input', function() {
      const q = this.value.trim();
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const flows = getFlows();
        const container = document.getElementById('flowCardsContainer');
        container.innerHTML = '';
        if (!q) return renderFlows();
        const filtered = searchFlows(flows, q);
        if (!filtered.length) {
          container.innerHTML = '<div style="color:#a5b4fc; text-align:center; padding:32px 0; font-size:1.1rem;">No matching flows found.</div>';
          return;
        }
        filtered.forEach((flow, i) => {
          container.innerHTML += flowCardHTML(flow.title, flow.flow, i, q);
        });
      }, 120);
    });

    // Highlight helper
    function highlightMatch(text, q) {
      if (!q) return escapeHTML(text);
      const tokens = q.trim().split(/\s+/).filter(Boolean);
      let result = escapeHTML(text);
      tokens.forEach(token => {
        if (!token) return;
        const regex = new RegExp(`(${token.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')})`, 'ig');
        result = result.replace(regex, '<span class="flow-highlight">$1</span>');
      });
      return result;
    }

    // Add highlight style
    const highlightStyle = document.createElement('style');
    highlightStyle.innerHTML = `
      .flow-highlight { 
        background:rgba(251,191,36,0.45); 
        color:#fff; 
        font-weight:bold; 
        border-radius:4px; 
        padding:0 2px; 
      }
      
      /* Mobile button hover states */
      @media (hover: hover) {
        .edit-btn:hover, .delete-btn:hover {
          background: rgba(139,92,246,0.1);
        }
        .add-btn:hover, .export-btn:hover, .import-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 16px 0 rgba(139,92,246,0.4);
        }
      }
      
      /* Mobile form validation */
      .add-title-input:invalid, .add-input:invalid {
        border: 1px solid rgba(239,68,68,0.5);
        box-shadow: 0 0 0 1px rgba(239,68,68,0.2);
      }
      
      /* Loading state for buttons */
      .add-btn:disabled, .export-btn:disabled, .import-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
    `;
    document.head.appendChild(highlightStyle);

    // Auto-resize textarea utility
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    }
    
    // Observe edit mode and attach auto-resize
    const flowCardsContainer = document.getElementById('flowCardsContainer');
    const observer = new MutationObserver(() => {
      const editTA = flowCardsContainer.querySelector('.edit-flow-input');
      if (editTA) {
        autoResizeTextarea(editTA);
        editTA.addEventListener('input', function() { autoResizeTextarea(this); });
      }
    });
    observer.observe(flowCardsContainer, { childList: true, subtree: true });
    
    // Mobile keyboard shortcuts and accessibility
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + Enter to add flow
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const titleInput = document.querySelector('.add-title-input');
        const flowInput = document.querySelector('.add-input');
        if (document.activeElement === titleInput || document.activeElement === flowInput) {
          e.preventDefault();
          document.querySelector('.add-btn').click();
        }
      }
      
      // Escape to cancel edit mode
      if (e.key === 'Escape') {
        const editCard = document.querySelector('.flow-card[data-index] .cancel-btn');
        if (editCard) {
          editCard.click();
        }
      }
    });
    
    // Mobile-friendly focus management
    document.querySelector('.add-title-input').addEventListener('keydown', function(e) {
      if (e.key === 'Tab' && !e.shiftKey) {
        e.preventDefault();
        document.querySelector('.add-input').focus();
      }
    });
    
    document.querySelector('.add-input').addEventListener('keydown', function(e) {
      if (e.key === 'Tab' && e.shiftKey) {
        e.preventDefault();
        document.querySelector('.add-title-input').focus();
      }
    });

    // --- EXPORT/IMPORT ---
    document.querySelector('.export-btn').onclick = function() {
      const flows = getFlows();
      if (!flows.length) {
        document.querySelector('.import-export-msg').textContent = 'No flows to export!';
        setTimeout(() => { document.querySelector('.import-export-msg').textContent = ''; }, 2000);
        return;
      }
      
      const exportBtn = document.querySelector('.export-btn');
      const originalText = exportBtn.textContent;
      exportBtn.textContent = 'Exporting...';
      exportBtn.disabled = true;
      
      const blob = new Blob([JSON.stringify(flows, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'trading-style-flows.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      
      document.querySelector('.import-export-msg').textContent = 'Exported!';
      setTimeout(() => { 
        document.querySelector('.import-export-msg').textContent = '';
        exportBtn.textContent = originalText;
        exportBtn.disabled = false;
      }, 1800);
    };
    document.getElementById('importFlowsInput').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const importBtn = document.querySelector('.import-btn');
      const originalText = importBtn.textContent;
      importBtn.textContent = 'Importing...';
      importBtn.style.opacity = '0.7';
      
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!Array.isArray(imported) || !imported.every(f => f.title && f.flow)) {
            document.querySelector('.import-export-msg').textContent = 'Invalid file format.';
            setTimeout(() => { 
              document.querySelector('.import-export-msg').textContent = '';
              importBtn.textContent = originalText;
              importBtn.style.opacity = '';
            }, 2500);
            return;
          }
          if (confirm(`Import will REPLACE all your current flows. Import ${imported.length} flows?`)) {
            saveFlows(imported);
            renderFlows();
            document.querySelector('.import-export-msg').textContent = `Imported ${imported.length} flows!`;
            setTimeout(() => { 
              document.querySelector('.import-export-msg').textContent = '';
              importBtn.textContent = originalText;
              importBtn.style.opacity = '';
            }, 2000);
          } else {
            importBtn.textContent = originalText;
            importBtn.style.opacity = '';
          }
        } catch {
          document.querySelector('.import-export-msg').textContent = 'Import failed - invalid JSON.';
          setTimeout(() => { 
            document.querySelector('.import-export-msg').textContent = '';
            importBtn.textContent = originalText;
            importBtn.style.opacity = '';
          }, 2500);
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    };
    </script>
  </div>
</body>
</html> 